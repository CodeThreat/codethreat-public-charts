{{- if .Values.appsec.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "codethreat.fullname" . }}-entrypoint
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "codethreat.labels" . | nindent 4 }}
data:
  docker-entrypoint.sh: |
    #!/bin/sh
    # CodeThreat Docker Entrypoint
    # Handles database migrations and application startup
    
    set -e
    
    # Color codes for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
    
    echo "${BLUE}ðŸš€ CodeThreat AppSec Platform Starting...${NC}"
    
    # Change to app directory where Prisma schema is located
    cd /app || { echo "${RED}âŒ Failed to change to /app directory${NC}"; exit 1; }
    
    # Function to wait for database to be ready
    wait_for_database() {
        echo "${YELLOW}â³ Waiting for database to be ready...${NC}"
        
        local max_attempts=30
        local attempt=1
        local schema_path="/app/prisma/schema.prisma"
        
        while [ $attempt -le $max_attempts ]; do
            if echo "SELECT 1;" | npx prisma db execute --stdin --schema "$schema_path" > /dev/null 2>&1; then
                echo "${GREEN}âœ… Database is ready${NC}"
                return 0
            fi
            
            echo "${YELLOW}â³ Database not ready yet (attempt $attempt/$max_attempts)...${NC}"
            sleep 2
            attempt=$((attempt + 1))
        done
        
        echo "${RED}âŒ Database failed to become ready after $max_attempts attempts${NC}"
        echo "${YELLOW}âš ï¸  Attempting to show last error (schema check)...${NC}"
        if [ ! -f "$schema_path" ]; then
            echo "${RED}âŒ Schema file not found at $schema_path${NC}"
            echo "${YELLOW}Checking for schema in current directory...${NC}"
            find . -name "schema.prisma" -type f 2>/dev/null | head -5 || echo "No schema.prisma found"
        fi
        return 1
    }
    
    # Function to run database migrations
    run_migrations() {
        echo "${YELLOW}ðŸ—„ï¸  Running database migrations...${NC}"
        
        local schema_path="/app/prisma/schema.prisma"
        
        # Generate Prisma client first
        echo "${YELLOW}ðŸ“¦ Generating Prisma client...${NC}"
        npx prisma generate --schema "$schema_path"
        
        # Check migration status
        echo "${YELLOW}ðŸ“Š Checking migration status...${NC}"
        if npx prisma migrate status --schema "$schema_path" > /dev/null 2>&1; then
            echo "${GREEN}âœ… Migration status check passed${NC}"
        else
            echo "${YELLOW}âš ï¸  Migration status check failed; attempting migration deploy${NC}"
        fi
        
        echo "${YELLOW}ðŸ”„ Deploying migrations...${NC}"
        npx prisma migrate deploy --schema "$schema_path"
        echo "${GREEN}âœ… Database migrations completed successfully${NC}"
    }
    
    # Run database setup (migrations are handled by Helm job, but we can check)
    if [ "${SKIP_DB_MIGRATIONS:-false}" != "true" ]; then
        wait_for_database
        if ! run_migrations; then
            echo "${RED}âŒ Database migration step failed${NC}"
            exit 1
        fi
        
        echo "${YELLOW}ðŸŒ± Running database seed...${NC}"
        if npx prisma db seed --schema /app/prisma/schema.prisma >/dev/null 2>&1; then
            echo "${GREEN}âœ… Database seed completed${NC}"
        else
            echo "${YELLOW}âš ï¸  Database seed failed or already applied; continuing${NC}"
        fi
    else
        echo "${BLUE}â„¹ï¸  Skipping database migrations (handled by Helm job)${NC}"
    fi
    
    # Start the application
    echo "${GREEN}ðŸš€ Starting CodeThreat AppSec Platform...${NC}"
    
    # Ensure uploads directory exists and is writable
    UPLOAD_DIR="${UPLOAD_FILE_PATH:-/tmp/uploads}"
    if [ ! -d "$UPLOAD_DIR" ]; then
        echo "${YELLOW}ðŸ“‚ Creating uploads directory at $UPLOAD_DIR${NC}"
        mkdir -p "$UPLOAD_DIR" || echo "${RED}âŒ Failed to create $UPLOAD_DIR${NC}"
    fi
    
    # If running as root, fix ownership/permissions of uploads dir and drop privileges
    if [ "$(id -u)" = "0" ]; then
        echo "${YELLOW}ðŸ” Adjusting permissions for $UPLOAD_DIR and dropping privileges...${NC}"
        TARGET_USER="nextjs"
        TARGET_GROUP="nodejs"
        if ! id -u "$TARGET_USER" >/dev/null 2>&1; then
            TARGET_USER="1001"
        fi
        if ! getent group "$TARGET_GROUP" >/dev/null 2>&1; then
            TARGET_GROUP="1001"
        fi
        
        chown -R "$TARGET_USER":"$TARGET_GROUP" "$UPLOAD_DIR" 2>/dev/null || true
        chmod -R 0775 "$UPLOAD_DIR" 2>/dev/null || true
        
        if command -v su >/dev/null 2>&1; then
            if [ "$1" = "next" ] && [ "$2" = "start" ]; then
                exec su -s /bin/sh -c "cd /app && npx next start" "$TARGET_USER"
            elif [ "$1" = "next" ]; then
                shift
                exec su -s /bin/sh -c "cd /app && npx next $*" "$TARGET_USER"
            else
                exec su -s /bin/sh -c "cd /app && $*" "$TARGET_USER"
            fi
        else
            echo "${YELLOW}âš ï¸  'su' not found; running command as root (less secure)${NC}"
            cd /app && exec "$@"
        fi
    else
        chmod -R 0775 "$UPLOAD_DIR" 2>/dev/null || true
        cd /app
        if [ "$1" = "next" ]; then
            shift
            exec npx next "$@"
        else
            exec "$@"
        fi
    fi
{{- end }}
